version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ft_trans_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U dev -d ft_trans']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ft_trans_network

  # Redis Cache & Session Store
  redis:
    image: redis:7-alpine
    container_name: ft_trans_redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ft_trans_network

  # NATS Message Bus
  nats:
    image: nats:latest
    container_name: ft_trans_nats
    restart: unless-stopped
    ports:
      - '4222:4222'
      - '8222:8222'
      - '6222:6222'
    command: '--http_port 8222 --js'
    networks:
      - ft_trans_network

  # Mailpit - Email Testing
  mailpit:
    image: axllent/mailpit:latest
    container_name: ft_trans_mailpit
    restart: unless-stopped
    ports:
      - '1025:1025'
      - '8025:8025'
    environment:
      MP_MAX_MESSAGES: 5000
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - ft_trans_network

  # API Gateway (NestJS)
  api-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    container_name: ft_trans_api_gateway
    restart: unless-stopped
    ports:
      - '4000:4000'
    volumes:
      - ./apps/api-gateway/src:/app/apps/api-gateway/src
      - ./apps/api-gateway/prisma:/app/apps/api-gateway/prisma
      - ./packages:/app/packages
    environment:
      - NODE_ENV=${NODE_ENV}
      - DATABASE_URL=${DATABASE_URL_DOCKER}
      - REDIS_URL=${REDIS_URL_DOCKER}
      - NATS_URL=${NATS_URL_DOCKER}
      - API_GATEWAY_PORT=${API_GATEWAY_PORT}
      - CORS_ORIGINS=${CORS_ORIGINS_DOCKER}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL_DOCKER}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_started
      auth-service:
        condition: service_started
      workspace-service:
        condition: service_started
    networks:
      - ft_trans_network

  # Auth Service (Microservice)
  auth-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.auth
    container_name: ft_trans_auth_service
    restart: unless-stopped
    ports:
      - '3001:3001'
    volumes:
      - ./services/auth-service/src:/app/services/auth-service/src
      - ./services/auth-service/prisma:/app/services/auth-service/prisma
      - ./packages:/app/packages
    environment:
      - NODE_ENV=${NODE_ENV}
      - DATABASE_URL=${DATABASE_URL_DOCKER}
      - NATS_URL=${NATS_URL_DOCKER}
      - PORT=${AUTH_PORT}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ft_trans_network

  # Workspace Service (Microservice)
  workspace-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.workspace
    container_name: ft_trans_workspace_service
    restart: unless-stopped
    ports:
      - '3002:3002'
    volumes:
      - ./services/workspace-service/src:/app/services/workspace-service/src
      - ./services/workspace-service/prisma:/app/services/workspace-service/prisma
      - ./packages:/app/packages
    environment:
      - NODE_ENV=${NODE_ENV}
      - DATABASE_URL=${DATABASE_URL_WORKSPACE}
      - NATS_URL=${NATS_URL_DOCKER}
      - PORT=${WORKSPACE_PORT}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - EMAIL_FROM=${EMAIL_FROM}
      - APP_URL=${APP_URL}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ft_trans_network

  # Web Frontend (Next.js)
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: ft_trans_web
    restart: unless-stopped
    ports:
      - '3000:3000'
    volumes:
      - ./apps/web/app:/app/apps/web/app
      - ./apps/web/components:/app/apps/web/components
      - ./apps/web/lib:/app/apps/web/lib
      - ./apps/web/public:/app/apps/web/public
      - ./packages:/app/packages
    environment:
      - NODE_ENV=${NODE_ENV}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL}
    depends_on:
      - api-gateway
    networks:
      - ft_trans_network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  ft_trans_network:
    driver: bridge
