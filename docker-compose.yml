services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ft_trans_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ft_trans}
      POSTGRES_USER: ${POSTGRES_USER:-dev}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-dev} -d ${POSTGRES_DB:-ft_trans}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ft_trans_network

  # Prisma Migration Runner
  prisma-migrate:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: prisma
    container_name: ft_trans_migrate
    command: sh -c "cd /app/packages/database && pnpm prisma:push --accept-data-loss"
    environment:
      - DATABASE_URL=${DATABASE_URL_DOCKER:-postgresql://dev:dev@postgres:5432/ft_trans}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ft_trans_network
    restart: "no"

  # Redis Cache & Session Store
  redis:
    image: redis:7-alpine
    container_name: ft_trans_redis
    restart: unless-stopped
    ports:
      - '6378:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ft_trans_network

  # NATS Message Bus
  nats:
    image: nats:latest
    container_name: ft_trans_nats
    restart: unless-stopped
    ports:
      - '4222:4222'
      - '8222:8222'
      - '6222:6222'
    command: '--http_port 8222 --js'
    networks:
      - ft_trans_network

  # Mailpit - Email Testing
  mailpit:
    image: axllent/mailpit:latest
    container_name: ft_trans_mailpit
    restart: unless-stopped
    ports:
      - '1025:1025'
      - '8025:8025'
    environment:
      MP_MAX_MESSAGES: 5000
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - ft_trans_network

  # API Gateway (NestJS)
  api-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: api-gateway-dev
    container_name: ft_trans_api_gateway
    restart: unless-stopped
    ports:
      - '4000:4000'
    volumes:
      - ./apps/api-gateway/src:/app/apps/api-gateway/src
      - ./packages/database/src:/app/packages/database/src
      - ./packages/backend-common/src:/app/packages/backend-common/src
      - ./packages/shared-types/src:/app/packages/shared-types/src
      - ./prisma:/app/prisma
      - /app/node_modules
      - /app/apps/api-gateway/node_modules
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DATABASE_URL=${DATABASE_URL_DOCKER:-postgresql://dev:dev@postgres:5432/ft_trans}
      - REDIS_URL=${REDIS_URL_DOCKER:-redis://redis:6379}
      - NATS_URL=${NATS_URL_DOCKER:-nats://nats:4222}
      - API_GATEWAY_PORT=${API_GATEWAY_PORT:-4000}
      - CORS_ORIGINS=${CORS_ORIGINS_DOCKER:-http://localhost:3000}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL_DOCKER:-http://auth-service:3001}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-localhost}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_started
      auth-service:
        condition: service_started
      workspace-service:
        condition: service_started
    networks:
      - ft_trans_network

  # Auth Service (Microservice)
  auth-service:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: auth-service-dev
    container_name: ft_trans_auth_service
    restart: unless-stopped
    ports:
      - '3001:3001'
    volumes:
      - ./services/auth-service/src:/app/services/auth-service/src
      - ./packages/database/src:/app/packages/database/src
      - ./packages/backend-common/src:/app/packages/backend-common/src
      - ./prisma:/app/prisma
      - /app/node_modules
      - /app/services/auth-service/node_modules
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DATABASE_URL=${DATABASE_URL_DOCKER:-postgresql://dev:dev@postgres:5432/ft_trans}
      - NATS_URL=${NATS_URL_DOCKER:-nats://nats:4222}
      - PORT=${AUTH_PORT:-3001}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-localhost}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@localhost}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
      prisma-migrate:
        condition: service_completed_successfully
    networks:
      - ft_trans_network

  # Workspace Service (Microservice)
  workspace-service:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: workspace-service-dev
    container_name: ft_trans_workspace_service
    restart: unless-stopped
    ports:
      - '3002:3002'
    volumes:
      - ./services/workspace-service/src:/app/services/workspace-service/src
      - ./packages/database/src:/app/packages/database/src
      - ./packages/backend-common/src:/app/packages/backend-common/src
      - ./packages/shared-types/src:/app/packages/shared-types/src
      - ./prisma:/app/prisma
      - /app/node_modules
      - /app/services/workspace-service/node_modules
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DATABASE_URL=${DATABASE_URL_DOCKER:-postgresql://dev:dev@postgres:5432/ft_trans}
      - NATS_URL=${NATS_URL_DOCKER:-nats://nats:4222}
      - PORT=${WORKSPACE_PORT:-3002}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@localhost}
      - APP_URL=${APP_URL:-http://localhost:3000}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
      prisma-migrate:
        condition: service_completed_successfully
    networks:
      - ft_trans_network

  # Web Frontend (Next.js)
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: web-dev
    container_name: ft_trans_web
    restart: unless-stopped
    ports:
      - '3000:3000'
    volumes:
      - ./apps/web/app:/app/apps/web/app
      - ./apps/web/components:/app/apps/web/components
      - ./apps/web/lib:/app/apps/web/lib
      - ./apps/web/public:/app/apps/web/public
      - ./apps/web/proxy.ts:/app/apps/web/proxy.ts
      - ./packages/shared-types/src:/app/packages/shared-types/src
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:4000}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:4000}
    depends_on:
      - api-gateway
    networks:
      - ft_trans_network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  ft_trans_network:
    driver: bridge
